---
title: Вызов кросс-программы (Cross Program Invocation=CPI)
sidebarLabel: Вызов кросс-программы
sidebarSortOrder: 6
---

Вызов кросс-программ (CPI) относится к ситуации, 
когда одна программа вызывает инструкции другой программы. 
Этот механизм обеспечивает компоновку программ Solana.

Вы можете думать об инструкциях как о конечных точках API, 
которые программа предоставляет сети, 
а CPI — как об одном API, вызывающем изнутри другой API.

![Вызов кросс-программ](/assets/docs/core/cpi/cpi.svg)

Когда программа инициирует межпрограммный вызов (CPI) для другой программы:

- Привилегии подписчика от начальной транзакции, 
  вызывающей вызывающую программу (A), распространяются на вызываемую программу (B)
- Вызываемая программа (B) может выполнять дальнейшие CPI для других программ, 
  вплоть до максимальной глубины 4 (например, B->C, C->D)
- Программы могут «подписываться» от имени [PDA](/docs/core/pda.md), 
  полученных из ее идентификатора программы


Программа Solana runtime определяет константу max_invoke_stack_height, которая установлена ​​в значение 5

Это представляет максимальную высоту стека вызова инструкций программы. Высота стека начинается с 1 для инструкций транзакции, увеличивается на 1 каждый раз, когда программа вызывает другую инструкцию. Эта настройка фактически ограничивает глубину вызова для CPI до 4.



> Программа Solana runtime определяет константу
> [`max_invoke_stack_height`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/program-runtime/src/compute_budget.rs#L31-L35),
> которая установлена в
> [значение 5](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/program-runtime/src/compute_budget.rs#L138).
> Это представляет максимальную высоту стека вызова инструкций программы. 
> Высота стека начинается с 1 для инструкций транзакции, увеличивается на 1 каждый раз, 
> когда программа вызывает другую инструкцию. 
> Эта настройка фактически ограничивает глубину вызова для CPI до 4.

## Ключевые моменты

- CPI позволяют инструкциям программы Solana напрямую вызывать инструкции 
  в другой программе.
- Привилегии подписчика из вызывающей программы распространяются 
  на вызываемую программу.
- При создании CPI программы могут «подписываться» от имени КПК, 
  полученных из их собственного идентификатора программы.
- Вызываемая программа может создавать дополнительные CPI для других программ,
  вплоть до максимальной глубины 4.

## Как написать CPI

Написание инструкции для CPI следует той же схеме, что и создание 
[инструкции](/docs/core/transactions.md#instruction) для добавления 
в транзакцию. Под капотом каждая инструкция CPI должна указывать 
следующую информацию:

- **Адрес программы**: указывает вызываемую программу
- **Учетные записи**: перечисляет все учетные записи, из которых инструкция 
  считывает или в которые записывает данные, включая другие программы
- **Данные инструкции**: указывает, какую инструкцию в программе вызывать,
  а также любые дополнительные данные, требуемые инструкцией (аргументы функции)

В зависимости от программы, к которой вы делаете вызов, могут быть доступны контейнеры
со вспомогательными функциями для создания инструкции. Затем программы выполняют CPI, 
используя одну из следующих функций из контейнера `solana_program`:

- `invoke` - используется, когда нет подписчиков PDA
- `invoke_signed` - используется, когда вызывающей программе необходимо подписать PDA,
  полученный из ее идентификатора программы

### Базовый CPI

[`Вызов`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/sdk/program/src/program.rs#L132)
функции используется при создании CPI, не требующего подписчиков PDA. 
При создании CPI подписчики, предоставленные вызывающей программе, 
автоматически распространяются на вызываемую программу.

```rust
pub fn invoke(
    instruction: &Instruction,
    account_infos: &[AccountInfo<'_>]
) -> Result<(), ProgramError>
```

Вот пример программы на [Solana Playground](https://beta.solpg.io/github.com/ZYJLiu/doc-examples/tree/main/cpi-invoke), которая создает CPI, используя функцию `invoke` 
для вызова инструкции передачи в System Program. Вы также можете обратиться к 
[руководству Basic CPI](/content/guides/getstarted/how-to-cpi.md) 
для получения дополнительных сведений.

### CPI with PDA Signer

Функция [`invoke_signed`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/sdk/program/src/program.rs#L247) 
используется при создании CPI, требующего подписчиков PDA. 
Семена, используемые для получения подписчиков PDA, 
передаются в функцию `invoke_signed` как `signer_seeds`.

Вы можете обратиться к странице [Program Derived Address](/docs/core/pda.md) 
для получения подробной информации о том, как получаются PDA.

```rust
pub fn invoke_signed(
    instruction: &Instruction,
    account_infos: &[AccountInfo<'_>],
    signers_seeds: &[&[&[u8]]]
) -> Result<(), ProgramError>
```

Среда выполнения использует привилегии, предоставленные вызывающей программе, 
чтобы определить, какие привилегии могут быть расширены для вызываемой стороны. 
Привилегии в этом контексте относятся к подписчикам и доступным для записи учетным записям.
Например, если инструкция, которую обрабатывает вызывающая сторона, содержит учетную запись
подписчика или доступную для записи учетную запись, то вызывающая сторона может вызвать
инструкцию, которая также содержит эту учетную запись подписчика и/или 
доступную для записи учетную запись.

Хотя у PDA нет [личных ключей](/docs/core/pda.md#what-is-a-pda), они все равно 
могут выступать в качестве подписчика в инструкции через CPI. 
Чтобы проверить, что PDA получен из вызывающей программы, семена, 
используемые для генерации PDA, должны быть включены как `signers_seeds`.

Когда CPI обрабатывается, среда выполнения Solana 
[внутренне вызывает `create_program_address`](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/programs/bpf_loader/src/syscalls/cpi.rs#L550) 
с использованием `signers_seeds` и `program_id` вызывающей программы. 
Если найден действительный PDA, адрес [добавляется как действительный подписывающий](https://github.com/solana-labs/solana/blob/27eff8408b7223bb3c4ab70523f8a8dca3ca6645/programs/bpf_loader/src/syscalls/cpi.rs#L552).

Вот пример программы на
[Solana Playground](https://beta.solpg.io/github.com/ZYJLiu/doc-examples/tree/main/cpi-invoke-signed), 
которая создает CPI, используя функцию `invoke_signed` для вызова инструкции передачи 
в системной программе с подписчиком PDA. Вы можете обратиться к 
[руководству CPI с подписчиком PDA](/content/guides/getstarted/how-to-cpi-with-signer.md) 
для получения дополнительных сведений.
